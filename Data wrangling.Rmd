---
title: "Data Wrangling"
author: "Paddy"
date: "30 April 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Data Wrangling 

The following file describes the main steps involved in wrangling the complete Approved Loan data set from Lending Club. The file can be found at the link https://data.world/jaypeedevlin/lending-club-loan-data-2007-11.
The current Approved Loan data provided on the Lending Club site does not include member FICO scores. Hence, I am using this data from a Data World user's profile as it will allow for more in depth analysis and better comparisons with the Rejected Loan data. 

## Step 1 - Import Data

Import relevent libraries and then import the raw data set (LC data).

```{r}
library(tidyr)
library(dplyr)
library(readr)
LC_data <- read_csv("~/Springboard/Capstone project/LC data.csv")

```
## Step 2 - Review Data Set

Display the data and remove any obvious columns - columns with little or no data and columns of little value.Firstly, rename the data frame to the shorter name of "lc". 

```{r}
lc <- LC_data

lc[, c("member_id", "funded_amnt", "sub_grade", "funded_amnt_inv", "url", "desc", "zip_code", "issue_d", "out_prncp", "out_prncp_inv")] <- NULL

```

## Step 3 - Delete Variables in Bulk

### NA columns
Removing columns made up of mostly NA row i.e. more than 80% of values are NA.

```{r}
missing_values <- sapply(lc, function(x) {
  percentage <- sum(is.na(x))/length(x)
  percentage < 0.2
  })
lc <- lc[, missing_values == TRUE]
lc
```

This reduces the number of variables from 115 to 49.

### Unique Value Columns

Remove columns with only 1 unique value. These columns will not add any value in the analysis.

Firstly, review the breakdown of the number of unique values in each column. NA values are omitted from this to give a better representation of the columns unique value count.

```{r}
unique_values <- sapply(lc, function(x) {
  length(unique(x[!is.na(x)]))
  })
unique_values
```
There are 5 columns with only one unique value:
    initial_list_status
    collections_12_mths_ex_med
    policy_code
    application_type
    chargeoff_within_12_mths
    
Remove columns with only 1 unique value.


```{r}
unique_values2 <- sapply(lc, function(x) {
size <- length(unique(x[!is.na(x)]))
size > 1
})
lc <- lc[, unique_values2 == TRUE]
```
If required, can investigate the breakdown of each column's uniqe values. For example, investigating the breakdown of column "grade":

```{r}
aggregate(data.frame(count = lc$grade), list(value = lc$grade), length)
```
However, features can be useful even when they are not spread equally. Hence, they will be left in the dataset. 

Variables "title" and "purpose" look similar. "title" has 20962 unique variables while "purpose" only has 14. "purpose" will be alot more useful than "title" as the reasons for the loan are grouped together better. This will involve alot less formatting than with "title" in order to be able to use the data. Hence, "title" is deleted.

```{r}
lc[, "title"] <- NULL
```

## Step 5 - Formatting

### Loan Purpose
There are 5 NA values which need to be assigned to the "other" column. 
```{r}
 lc <- lc %>% mutate(purpose = replace(purpose, is.na(purpose), "other"))
```

None of the sub sections for "purpose" are similar enough to concatanate into one sub section. However, "major_purchase" is vague and does not give much insight into the purchase. "major_purchase" items will come under the "other" sub section. 

```{r}
 lc$purpose <- gsub('major_purchase', "other", lc$purpose)
```
### Interest Rate
Int_rate column is currently classed as a character. Removing the % sign, converting to numeric and changing the name of the column to specify the unit is in percent.

```{r}
 lc$int_rate <- gsub('\\%', "", lc$int_rate)
 lc$int_rate <- as.numeric(lc$int_rate)
 
 library(data.table)
 setnames(lc, "int_rate", "int_rate_percent")

```

### Term
Remove the word "months"" in each observation in "term" column, convert to numeric and change the name of the column to specify unit is in months. 

```{r}
lc$term <- gsub("months", "", lc$term)
lc$term <- as.numeric(lc$term)
setnames(lc, "term", "term_mths")
```

### Employment Length
Remove the word "years" in each observation in "emp_length" column and change name of the column to show the time period is in years. Change <1 years to 0 and 10+ years to 10. Leave as character for the moment as it includes NA values (NA coersion).  

```{r}
lc$emp_length <- gsub("year|years", "", lc$emp_length)
lc$emp_length <- gsub("< 1", "0", lc$emp_length)
lc$emp_length <- gsub("\\+", "", lc$emp_length)
setnames(lc, "emp_length", "emp_length_yrs")
```

## Step 6 - One Hot Encoding

 
```{r}
library(ade4)
ohe_feats = c('term_mths', 'grade', 'sub_grade', 'emp_length_yrs', 'home_ownership', 'loan_status', 'delinq_2yrs', 'inq_last_6mths', 'pub_rec', 'policy_code', 'application_type', 'pub_rec_bankruptcies')
for(f in ohe_feats) {
      df_dummy1 = acm.disjonctif(lc[f])
      lc[f] = NULL
      lc = cbind(lc, df_dummy1)
}
```


